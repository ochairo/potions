name: Scheduled Release

run-name: ${{ inputs.package && format('Release {0}', inputs.package) || 'Scheduled Release' }}

on:
  schedule:
    # [UTC] Run every 15 minutes at :00, :15, :30, and :45
    # [JST] Run every 15 minutes (UTC+9)
    - cron: "0,15,30,45 * * * *"
  workflow_dispatch:
    inputs:
      package:
        description: "Package to build and release (leave empty for all monitored packages)"
        required: false
        type: string
      version:
        description: "Specific version to build (leave empty for latest)"
        required: false
        type: string
      max_updates:
        description: "Maximum number of packages to release (1-10)"
        required: false
        default: "1"
        type: string
      dry_run:
        description: "Dry run mode (skip actual release)"
        required: false
        default: false
        type: boolean

permissions:
  contents: write # Required for creating releases and uploading assets
  packages: write # Required for package operations
  actions: read # Required for downloading artifacts from workflow runs
  id-token: write # Required for Sigstore/Cosign keyless signing and GitHub Attestations
  attestations: write # Required for generating GitHub Attestations

# Allow concurrent runs for different packages, but prevent duplicates of the same package
concurrency:
  group: build-and-release-${{ github.event.inputs.package || 'scheduled' }}-${{ github.ref }}
  cancel-in-progress: false

# This workflow has no timeout (relies on individual job timeouts: max 6 hours per job)

jobs:
  detect-updates:
    name: Detect Package Updates
    uses: ./.github/workflows/_scheduled-release_detect-updates.yml
    with:
      package: ${{ inputs.package || '' }}
      version: ${{ inputs.version || '' }}
      max_updates: ${{ inputs.max_updates || '1' }}
    secrets:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-binaries-linux-x86_64:
    name: Build Binaries (Linux x86_64)
    needs: detect-updates
    if: needs.detect-updates.outputs.has-updates == 'true'
    uses: ./.github/workflows/_scheduled-release_build-binaries-linux-x86_64.yml
    with:
      batches: ${{ needs.detect-updates.outputs.batches }}

  build-binaries-linux-arm64:
    name: Build Binaries (Linux ARM64)
    needs: detect-updates
    if: needs.detect-updates.outputs.has-updates == 'true'
    uses: ./.github/workflows/_scheduled-release_build-binaries-linux-arm64.yml
    with:
      batches: ${{ needs.detect-updates.outputs.batches }}

  build-binaries-macos-arm64:
    name: Build Binaries (macOS ARM64)
    needs: detect-updates
    if: needs.detect-updates.outputs.has-updates == 'true'
    uses: ./.github/workflows/_scheduled-release_build-binaries-macos-arm64.yml
    with:
      batches: ${{ needs.detect-updates.outputs.batches }}

  build-binaries-macos-x86_64:
    name: Build Binaries (macOS Intel)
    needs: detect-updates
    if: needs.detect-updates.outputs.has-updates == 'true'
    uses: ./.github/workflows/_scheduled-release_build-binaries-macos-x86_64.yml
    with:
      batches: ${{ needs.detect-updates.outputs.batches }}

  release-packages:
    name: Release Packages
    needs:
      [
        detect-updates,
        build-binaries-linux-x86_64,
        build-binaries-linux-arm64,
        build-binaries-macos-arm64,
        build-binaries-macos-x86_64,
      ]
    # Only run if detect-updates succeeded AND at least one build job succeeded
    if: |
      always() &&
      needs.detect-updates.result == 'success' &&
      github.event.inputs.dry_run != 'true' &&
      (needs.build-binaries-linux-x86_64.result == 'success' ||
       needs.build-binaries-linux-arm64.result == 'success' ||
       needs.build-binaries-macos-arm64.result == 'success' ||
       needs.build-binaries-macos-x86_64.result == 'success')
    uses: ./.github/workflows/_scheduled-release_release-packages.yml
    with:
      packages: ${{ needs.detect-updates.outputs.packages }}
      run_id: ${{ github.run_id }}
    secrets:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  workflow-summary:
    name: Workflow Summary
    runs-on: ubuntu-latest
    # Only run if at least one build job completed (success or failure)
    if: |
      needs.detect-updates.result == 'success' &&
      (needs.build-binaries-linux-x86_64.result != 'skipped' ||
       needs.build-binaries-linux-arm64.result != 'skipped' ||
       needs.build-binaries-macos-arm64.result != 'skipped' ||
       needs.build-binaries-macos-x86_64.result != 'skipped')
    permissions:
      actions: read # Required for artifact download
    needs:
      [
        detect-updates,
        build-binaries-linux-x86_64,
        build-binaries-linux-arm64,
        build-binaries-macos-arm64,
        build-binaries-macos-x86_64,
        release-packages,
      ]
    steps:
      - name: Download all failure reports
        if: always()
        uses: actions/download-artifact@018cc2cf5baa6db3ef3c5f8a56943fffe632ef53 # v6
        with:
          pattern: "*-batch-*-failures"
          path: failure-reports
          merge-multiple: true
        continue-on-error: true

      - name: Download all success markers
        if: always()
        uses: actions/download-artifact@018cc2cf5baa6db3ef3c5f8a56943fffe632ef53 # v6
        with:
          pattern: "*-batch-*-complete"
          path: success-reports
          merge-multiple: true
        continue-on-error: true

      - name: Checkout code
        uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v5

      - name: Generate workflow summary
        run: |
          .github/scripts/generate-workflow-summary.sh \
            "${{ github.run_id }}" \
            "${{ github.server_url }}" \
            "${{ github.repository }}" \
            "${{ github.ref_name }}" \
            "${{ needs.detect-updates.result }}" \
            "${{ needs.build-binaries-linux-x86_64.result }}" \
            "${{ needs.build-binaries-linux-arm64.result }}" \
            "${{ needs.build-binaries-macos-arm64.result }}" \
            "${{ needs.build-binaries-macos-x86_64.result }}" \
            "${{ needs.release-packages.result }}"
