name: "_Scheduled Release - Build Binaries macOS ARM64"

on:
  workflow_call:
    inputs:
      batches:
        description: "JSON array of batches to build"
        required: true
        type: string

permissions:
  contents: read

jobs:
  build-binaries-macos-arm64:
    name: Build Binaries (macOS ARM64)
    runs-on: macos-latest
    timeout-minutes: 120
    strategy:
      fail-fast: false
      max-parallel: 10
      matrix:
        batch: ${{ fromJson(inputs.batches) }}

    steps:
      - name: Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v5

      - name: Install system dependencies
        run: |
          # Retry logic for brew in case of transient failures
          for attempt in {1..3}; do
            if brew install gpgme libgpg-error autoconf automake 2>&1 | grep -v "already installed"; then
              echo "‚úÖ Dependencies installed"
              break
            fi
            if [ $attempt -lt 3 ]; then
              echo "‚ö†Ô∏è  Attempt $attempt failed, retrying in 10s..."
              brew update || true
              sleep 10
            else
              echo "‚ùå Failed to install dependencies after 3 attempts"
              exit 1
            fi
          done

      - name: Check available disk space
        run: |
          echo "üìä Available disk space:"
          df -h
          echo ""
          echo "üìä Free memory:"
          vm_stat || true

      - name: Setup Go
        uses: actions/setup-go@7a3fe6cf4cb3a834922a1244abfce67bcef6a0c5 # v6
        with:
          go-version-file: go.mod
          cache: true

      - name: Build potions CLI
        run: |
          go build -v -o bin/potions ./cmd/potions
          chmod +x bin/potions

      - name: Filter packages for this platform (macOS ARM64)
        id: filter-packages
        run: |
          PLATFORM="darwin-arm64"
          ALL_PACKAGES='${{ toJson(matrix.batch.packages) }}'

          # Filter packages that support this platform (both darwin-arm64 and macos-arm64 formats)
          FILTERED_PACKAGES=$(echo "$ALL_PACKAGES" | jq -c '[.[] | select(.platforms | any(. == "darwin-arm64" or . == "macos-arm64"))]')

          FILTERED_COUNT=$(echo "$FILTERED_PACKAGES" | jq 'length')
          TOTAL_COUNT=$(echo "$ALL_PACKAGES" | jq 'length')

          if [ $FILTERED_COUNT -lt $TOTAL_COUNT ]; then
            SKIPPED=$(( TOTAL_COUNT - FILTERED_COUNT ))
            echo "‚è≠Ô∏è  Skipping $SKIPPED packages that don't support $PLATFORM"
            echo "$ALL_PACKAGES" | jq -r '.[] | select(.platforms | any(. == "darwin-arm64" or . == "macos-arm64") | not) | "  - \(.package) (supports: \(.platforms | join(", ")))"'
          fi
          echo "filtered_packages=$FILTERED_PACKAGES" >> $GITHUB_OUTPUT
          echo "üì¶ Building $FILTERED_COUNT/$TOTAL_COUNT packages for $PLATFORM"

      - name: Build all packages in batch (macOS ARM64 only)
        if: fromJson(steps.filter-packages.outputs.filtered_packages)[0] != null
        run: |
          ./bin/potions build \
            --packages '${{ steps.filter-packages.outputs.filtered_packages }}' \
            --platform darwin-arm64 \
            --recipes-dir recipes \
            --output-dir dist \
            --enable-security-scan \
            --timeout 20 \
            --successes build-successes.txt \
            --failures build-failures.txt \
            --timeouts build-failures-timeout.txt \
            --errors build-failures-error.txt

      - name: Create failure tracking artifact
        if: always()
        run: .github/scripts/create-failure-tracking.sh "macos-arm64" "${{ matrix.batch.id }}"

      - name: Upload failure tracking
        if: always()
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5
        with:
          name: failure-tracking-macos-arm64-batch-${{ matrix.batch.id }}
          path: failure-tracking.json
          retention-days: 3

      - name: Upload build failures report
        if: always()
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5
        with:
          name: macos-arm64-batch-${{ matrix.batch.id }}-failures
          path: |
            build-failures.txt
            build-failures-timeout.txt
            build-failures-error.txt
          retention-days: 3
          if-no-files-found: ignore

      - name: Check for artifacts
        id: check-artifacts
        run: |
          if [ -n "$(find dist -name '*.tar.gz' -type f 2>/dev/null)" ]; then
            echo "has-artifacts=true" >> $GITHUB_OUTPUT

            # Calculate total artifact size
            TOTAL_SIZE=$(du -sh dist 2>/dev/null | cut -f1)
            ARTIFACT_COUNT=$(find dist -name '*.tar.gz' -type f 2>/dev/null | wc -l | tr -d ' ')
            echo "üìä Artifacts: $ARTIFACT_COUNT files, Total size: $TOTAL_SIZE"

            # Check for unusually large artifacts (>500MB warning)
            find dist -name '*.tar.gz' -type f -size +500M 2>/dev/null | while read large_file; do
              FILE_SIZE=$(du -h "$large_file" | cut -f1)
              echo "‚ö†Ô∏è  Large artifact detected: $(basename "$large_file") ($FILE_SIZE)"
            done
          else
            echo "has-artifacts=false" >> $GITHUB_OUTPUT
            echo "‚ÑπÔ∏è  No artifacts produced for this batch (likely custom build types)"
          fi

      - name: Upload artifacts
        if: success() && steps.check-artifacts.outputs.has-artifacts == 'true'
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5
        with:
          name: macos-arm64-batch-${{ matrix.batch.id }}-builds
          path: dist/
          retention-days: 3
          include-hidden-files: false

      - name: Upload build completion marker
        if: success() && steps.check-artifacts.outputs.has-artifacts == 'true'
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5
        with:
          name: macos-arm64-batch-${{ matrix.batch.id }}-complete
          path: build-successes.txt
          retention-days: 1

      - name: Cleanup build artifacts
        if: always()
        run: |
          echo "üßπ Cleaning up build directory..."
          if [ -d dist ]; then
            chmod -R u+w dist
            rm -rf dist
          fi
          echo "üìä Final disk space:"
          df -h
