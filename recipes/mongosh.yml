name: mongosh
description: Modern MongoDB Shell - Interactive JavaScript shell for MongoDB
version:
  source: "github-release:mongodb-js/mongosh"
  extract_pattern: '[0-9]+\.[0-9]+\.[0-9]+'

build_type: custom

download:
  official_binary: true
  download_url: "https://github.com/mongodb-js/mongosh/releases/download/v{version}/mongosh-{version}-{suffix}"
  platforms:
    darwin-arm64:
      suffix: "darwin-arm64.zip"
    darwin-x86_64:
      suffix: "darwin-x64.zip"
    linux-amd64:
      suffix: "linux-x64.tgz"
    linux-arm64:
      suffix: "linux-arm64.tgz"

security:
  verify_signature: false
  # gpg_keys_url: ""  # Add URL to project KEYS file for auto-import
  scan_vulnerabilities: true

configure:
  script: |
    # Extract archive (handles both .zip and .tgz)
    if [ -f mongosh-*.zip ]; then
      unzip -q mongosh-*.zip
    elif [ -f mongosh-*.tgz ]; then
      tar xzf mongosh-*.tgz
    fi

build:
  custom_install: |
    mkdir -p $PREFIX/bin

    # Find mongosh binary (could be in bin/ or directly in extraction dir)
    MONGOSH_BINARY=""
    if [ -f mongosh-*/bin/mongosh ]; then
      MONGOSH_BINARY=$(ls mongosh-*/bin/mongosh | head -1)
    elif [ -f mongosh-*/mongosh ]; then
      MONGOSH_BINARY=$(ls mongosh-*/mongosh | head -1)
    elif [ -f bin/mongosh ]; then
      MONGOSH_BINARY="bin/mongosh"
    elif [ -f mongosh ]; then
      MONGOSH_BINARY="mongosh"
    fi

    if [ -z "$MONGOSH_BINARY" ] || [ ! -f "$MONGOSH_BINARY" ]; then
      echo "Error: mongosh binary not found" >&2
      echo "Directory contents:" >&2
      ls -la >&2
      find . -name mongosh -type f 2>/dev/null >&2
      exit 1
    fi

    cp "$MONGOSH_BINARY" $PREFIX/bin/mongosh || {
      echo "Error: Failed to copy mongosh binary" >&2
      exit 1
    }

    chmod +x $PREFIX/bin/mongosh

    # Verify installation
    if [ ! -x "$PREFIX/bin/mongosh" ]; then
      echo "Error: mongosh binary not executable after installation" >&2
      exit 1
    fi
