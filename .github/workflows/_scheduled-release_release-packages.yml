name: "_Scheduled Release - Release Packages"

on:
  workflow_call:
    inputs:
      packages:
        description: "JSON array of packages to check for release"
        required: true
        type: string
      run_id:
        description: "Workflow run ID for artifact download"
        required: true
        type: string
    secrets:
      GH_TOKEN:
        required: true

permissions:
  contents: write
  actions: read
  id-token: write # Required for GitHub Attestations and Sigstore signing
  attestations: write # Required for artifact attestations

jobs:
  release-packages:
    name: Release Packages
    runs-on: ubuntu-latest
    timeout-minutes: 120
    steps:
      - name: Checkout code
        uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v5

      - name: Check available disk space
        run: .github/scripts/check-disk-space.sh 20

      - name: Set up Go
        uses: actions/setup-go@44694675825211faa026b3c33043df3e48a5fa00 # v6
        with:
          go-version-file: go.mod
          cache: false # Disabled - job only builds CLI once, prevents cleanup warnings

      - name: Build potions CLI
        run: |
          go build -v -o bin/potions ./cmd/potions
          chmod +x bin/potions

      - name: Wait for artifact uploads
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
        run: .github/scripts/wait-for-artifacts.sh '${{ inputs.packages }}' '${{ inputs.run_id }}'

      - name: Check GitHub API rate limits
        run: |
          echo "ğŸ” Checking GitHub API rate limits..."
          RATE_INFO=$(gh api rate_limit --jq '.rate')
          REMAINING=$(echo "$RATE_INFO" | jq -r '.remaining')
          LIMIT=$(echo "$RATE_INFO" | jq -r '.limit')
          RESET_TIME=$(echo "$RATE_INFO" | jq -r '.reset')

          echo "ğŸ“Š API Rate Limit: $REMAINING / $LIMIT remaining"

          if [ "$REMAINING" -lt 100 ]; then
            CURRENT_TIME=$(date +%s)
            WAIT_TIME=$((RESET_TIME - CURRENT_TIME + 60))
            if [ "$WAIT_TIME" -gt 0 ] && [ "$WAIT_TIME" -lt 3600 ]; then
              echo "âš ï¸  Low rate limit ($REMAINING remaining). Waiting ${WAIT_TIME}s for reset..."
              sleep "$WAIT_TIME"
            else
              echo "âš ï¸  Low rate limit but proceeding anyway (reset time: $(date -d @$RESET_TIME 2>/dev/null || date -r $RESET_TIME))"
            fi
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Download artifacts
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
        run: .github/scripts/download-artifacts.sh '${{ inputs.run_id }}' current-artifacts

      - name: Flatten artifacts directory
        run: .github/scripts/flatten-artifacts.sh current-artifacts

      - name: Verify artifact integrity
        run: |
          echo "ğŸ” Verifying artifact checksums..."

          # Debug: Show what files we have before verification
          echo "ğŸ“‹ Files before verification:"
          find current-artifacts -type f -name '*.tar.gz' -o -name '*.sha256' | sort | while read -r f; do
            echo "   - $(basename "$f")"
          done

          VERIFIED=0
          FAILED=0
          CORRUPTED_FILES=$(mktemp)

          find current-artifacts -name '*.tar.gz' -type f 2>/dev/null | while read -r tarball; do
            if [ -f "${tarball}.sha256" ]; then
              echo "ğŸ” Verifying $(basename "$tarball")..."
              if ./bin/potions verify --checksum "${tarball}.sha256" "$tarball"; then
                echo "âœ… Verified: $(basename "$tarball")"
                echo "verified" >> "$CORRUPTED_FILES"
              else
                echo "âŒ Checksum verification failed for $(basename "$tarball")"
                echo "failed" >> "$CORRUPTED_FILES"
                rm -f "$tarball" "${tarball}.sha256"
              fi
            else
              echo "âš ï¸  No checksum file for $(basename "$tarball") - keeping tarball"
            fi
          done

          VERIFIED=$(grep -c "verified" "$CORRUPTED_FILES" 2>/dev/null || echo 0)
          FAILED=$(grep -c "failed" "$CORRUPTED_FILES" 2>/dev/null || echo 0)
          rm -f "$CORRUPTED_FILES"

          echo "ğŸ“Š Verification: $VERIFIED passed, $FAILED failed"

          if [ "$FAILED" -gt 0 ]; then
            echo "âš ï¸  Warning: $FAILED corrupted artifacts removed"
          fi

          # Debug: Show what files we have after verification
          echo "ğŸ“‹ Files after verification:"
          find current-artifacts -type f \( -name '*.tar.gz' -o -name '*.sha256' -o -name '*.sha512' \) | sort | while read -r f; do
            echo "   - $(basename "$f")"
          done

      - name: Sign artifacts with Cosign (Sigstore)
        run: .github/scripts/sign-with-cosign.sh current-artifacts
        env:
          COSIGN_EXPERIMENTAL: "1" # Enable keyless signing

      - name: Sign artifacts with GPG
        if: vars.GPG_SIGNING_ENABLED == 'true'
        run: |
          .github/scripts/sign-with-gpg.sh \
            current-artifacts \
            "${{ secrets.GPG_PRIVATE_KEY }}" \
            "${{ secrets.GPG_PASSPHRASE }}"

      - name: Generate GitHub Attestations
        if: false # Disabled: gh CLI version doesn't support 'gh attest' command yet
        run: |
          # Find all artifacts and generate attestations
          find current-artifacts -type f \( -name '*.tar.gz' -o -name '*.sha256' -o -name '*.sbom.json' \) | while read -r artifact; do
            echo "ğŸ” Attesting: $(basename "$artifact")"
            gh attest \
              --bundle "${artifact}.attestation.jsonl" \
              "$artifact" || echo "âš ï¸  Attestation failed for $(basename "$artifact")"
          done
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Process releases
        run: |
          echo "ğŸš€ Processing package releases..."

          # Use CLI to handle entire release process
          ./bin/potions release \
            --packages '${{ inputs.packages }}' \
            --artifacts current-artifacts \
            --recipes recipes \
            --owner ${{ github.repository_owner }} \
            --repo ${{ github.event.repository.name }} \
            --failures release-failures.txt \
            --successes release-successes.txt
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Release Summary
        if: always()
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“Š Release Summary"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

          SUCCESS_COUNT=0
          FAILURE_COUNT=0

          if [ -f release-successes.txt ]; then
            SUCCESS_COUNT=$(wc -l < release-successes.txt | tr -d ' ')
            echo "âœ… Releases created: $SUCCESS_COUNT"
            if [ -s release-successes.txt ]; then
              echo ""
              echo "Successful releases:"
              cat release-successes.txt | while read line; do
                echo "  â€¢ $line"
              done
            fi
          else
            echo "âœ… Releases created: 0"
          fi

          if [ -f release-failures.txt ]; then
            FAILURE_COUNT=$(wc -l < release-failures.txt | tr -d ' ')
            echo ""
            echo "âŒ Failed releases: $FAILURE_COUNT"
            if [ -s release-failures.txt ]; then
              echo ""
              echo "Failed releases:"
              cat release-failures.txt | while read line; do
                echo "  â€¢ $line"
              done
            fi
          else
            echo ""
            echo "âŒ Failed releases: 0"
          fi

          TOTAL=$((SUCCESS_COUNT + FAILURE_COUNT))
          if [ "$TOTAL" -gt 0 ]; then
            SUCCESS_RATE=$(awk "BEGIN {printf \"%.1f\", $SUCCESS_COUNT * 100.0 / $TOTAL}")
            echo ""
            echo "ğŸ“¦ Total packages processed: $TOTAL"
            echo "ğŸ¯ Success rate: ${SUCCESS_RATE}%"
          fi
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

          # Note: Don't exit here - let the "Process releases" step failure propagate
          # This allows failure tracking to be uploaded even when all releases fail
          if [ "$SUCCESS_COUNT" -eq 0 ] && [ "$FAILURE_COUNT" -gt 0 ]; then
            echo ""
            echo "âš ï¸  Warning: All release attempts failed"
          fi

      - name: Create failure tracking for failed releases
        if: always()
        run: |
          # Extract package names from failure messages and create tracking JSON
          if [ -f release-failures.txt ] && [ -s release-failures.txt ]; then
            echo "ğŸ“ Creating failure tracking for failed releases..."

            # Parse failures and extract package names
            # Format: "package v1.2.3 - ERROR: message"
            FAILED_PACKAGES=$(cat release-failures.txt | sed -E 's/ v[0-9].* -.*//' | jq -R -s -c 'split("\n") | map(select(length > 0))')

            echo "Failed packages: $FAILED_PACKAGES"
            echo "$FAILED_PACKAGES" > failure-tracking.json

            echo "âœ… Failure tracking created"
          else
            echo "[]" > failure-tracking.json
            echo "â„¹ï¸  No failures to track"
          fi

      - name: Upload failure tracking
        if: always()
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5
        with:
          name: failure-tracking-release
          path: failure-tracking.json
          retention-days: 3

      - name: Upload release report
        if: always()
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5
        with:
          name: release-report
          path: |
            release-failures.txt
            release-successes.txt
          retention-days: 30
          if-no-files-found: ignore
