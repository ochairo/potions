name: "_Scheduled Release - Build Binaries Linux ARM64"

on:
  workflow_call:
    inputs:
      batches:
        description: "JSON array of batches to build"
        required: true
        type: string

permissions:
  contents: read

jobs:
  build-binaries-linux-arm64:
    name: Build Binaries (Linux ARM64)
    runs-on: ubuntu-latest
    timeout-minutes: 120
    strategy:
      fail-fast: false
      max-parallel: 10
      matrix:
        batch: ${{ fromJson(inputs.batches) }}

    steps:
      - name: Checkout code
        uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v5

      - name: Install system dependencies
        run: |
          # Retry logic for apt-get in case of transient failures
          for attempt in {1..3}; do
            if sudo apt-get update && sudo apt-get install -y libgpgme-dev libseccomp-dev autoconf automake libtool; then
              echo "âœ… Dependencies installed successfully"
              break
            fi
            if [ $attempt -lt 3 ]; then
              echo "âš ï¸  Attempt $attempt failed, retrying in 10s..."
              sleep 10
            else
              echo "âŒ Failed to install dependencies after 3 attempts"
              exit 1
            fi
          done

      - name: Check available disk space
        run: |
          echo "ðŸ“Š Available disk space:"
          df -h
          echo ""
          echo "ðŸ“Š Free memory:"
          free -h || true

      - name: Setup Go
        uses: actions/setup-go@44694675825211faa026b3c33043df3e48a5fa00 # v6
        with:
          go-version-file: go.mod
          cache: true

      - name: Build potions CLI
        run: |
          go build -v -o bin/potions ./cmd/potions
          chmod +x bin/potions

      - name: Filter packages for this platform (Linux ARM64)
        id: filter-packages
        run: |
          FILTERED_PACKAGES=$(.github/scripts/filter-packages-by-platform.sh "linux-arm64" '${{ toJson(matrix.batch.packages) }}')
          echo "filtered_packages=$FILTERED_PACKAGES" >> $GITHUB_OUTPUT

      - name: Build all packages in batch (Linux ARM64 only)
        if: fromJson(steps.filter-packages.outputs.filtered_packages)[0] != null
        run: |
          ./bin/potions build \
            --packages '${{ steps.filter-packages.outputs.filtered_packages }}' \
            --platform linux-arm64 \
            --recipes-dir recipes \
            --output-dir dist \
            --enable-security-scan \
            --timeout 20 \
            --successes build-successes.txt \
            --failures build-failures.txt \
            --timeouts build-failures-timeout.txt \
            --errors build-failures-error.txt

      - name: Create failure tracking artifact
        if: always()
        run: .github/scripts/create-failure-tracking.sh "linux-arm64" "${{ matrix.batch.id }}"

      - name: Upload failure tracking
        if: always()
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5
        with:
          name: failure-tracking-linux-arm64-batch-${{ matrix.batch.id }}
          path: failure-tracking.json
          retention-days: 3

      - name: Upload build failures report
        if: always()
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5
        with:
          name: linux-arm64-batch-${{ matrix.batch.id }}-failures
          path: |
            build-failures.txt
            build-failures-timeout.txt
            build-failures-error.txt
          retention-days: 3
          if-no-files-found: ignore

      - name: Check for artifacts
        id: check-artifacts
        run: |
          if [ -n "$(find dist -name '*.tar.gz' -type f 2>/dev/null)" ]; then
            echo "has-artifacts=true" >> $GITHUB_OUTPUT

            # Calculate total artifact size
            TOTAL_SIZE=$(du -sh dist 2>/dev/null | cut -f1)
            ARTIFACT_COUNT=$(find dist -name '*.tar.gz' -type f 2>/dev/null | wc -l | tr -d ' ')
            echo "ðŸ“Š Artifacts: $ARTIFACT_COUNT files, Total size: $TOTAL_SIZE"

            # Check for unusually large artifacts (>500MB warning)
            find dist -name '*.tar.gz' -type f -size +500M 2>/dev/null | while read large_file; do
              FILE_SIZE=$(du -h "$large_file" | cut -f1)
              echo "âš ï¸  Large artifact detected: $(basename "$large_file") ($FILE_SIZE)"
            done
          else
            echo "has-artifacts=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸  No artifacts produced for this batch (likely custom build types)"
          fi

      - name: Upload artifacts
        if: success() && steps.check-artifacts.outputs.has-artifacts == 'true'
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5
        with:
          name: linux-arm64-batch-${{ matrix.batch.id }}-builds
          path: dist/
          retention-days: 3
          include-hidden-files: false

      - name: Upload build completion marker
        if: success() && steps.check-artifacts.outputs.has-artifacts == 'true'
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5
        with:
          name: linux-arm64-batch-${{ matrix.batch.id }}-complete
          path: build-successes.txt
          retention-days: 1

      - name: Cleanup build artifacts
        if: always()
        run: |
          echo "ðŸ§¹ Cleaning up build directory..."
          if [ -d dist ]; then
            find dist -type d -exec chmod u+w {} \; 2>/dev/null || true
            find dist -type f -exec chmod u+w {} \; 2>/dev/null || true
            rm -rf dist
          fi
          echo "ðŸ“Š Final disk space:"
          df -h
