name: btop
version:
  source: "github-release:aristocratos/btop"
  exclude_patterns: "(alpha|beta|rc|dev|preview|pre|snapshot|nightly|test|unstable|canary|next|edge|weekly|daily)"
  extract_pattern: 'v[0-9]+\.[0-9]+\.[0-9]+'
  cleanup: "v:"
build_type: custom
description: "Resource monitor - better top/htop (C++)"

download:
  method: git
  git_url: https://github.com/aristocratos/btop.git
  git_tag_prefix: "v"

platforms:
  darwin-x86_64: {}
  darwin-arm64: {}
  linux-amd64:
    download_url: "https://github.com/aristocratos/btop/releases/download/v{version}/btop-{arch}-{os}-musl.tbz"
    os: "linux"
    arch: "x86_64"
  linux-arm64:
    download_url: "https://github.com/aristocratos/btop/releases/download/v{version}/btop-{arch}-{os}-musl.tbz"
    os: "linux"
    arch: "aarch64"

security:
  verify_signature: false
  scan_vulnerabilities: true

configure:
  script: |
    case "$(uname -s)" in
      Darwin*)
        # macOS: build from source using cmake
        echo "Configuring btop for macOS..."
        mkdir -p build
        cd build
        cmake ..
        ;;
      *)
        # Linux: extract prebuilt binary
        tar xjf btop-*.tbz
        ;;
    esac

build:
  timeout_minutes: 30
  custom_install: |
    mkdir -p "$PREFIX/bin"

    case "$(uname -s)" in
      Darwin*)
        # macOS: compile from source
        echo "Compiling btop for macOS..."
        cd build
        make -j$(sysctl -n hw.ncpu)
        cp btop "$PREFIX/bin/btop"
        ;;
      *)
        # Linux: use prebuilt binary
        if [ -f "btop/bin/btop" ]; then
          cp btop/bin/btop "$PREFIX/bin/btop"
        elif [ -f "bin/btop" ]; then
          cp bin/btop "$PREFIX/bin/btop"
        elif [ -f "btop" ]; then
          cp btop "$PREFIX/bin/btop"
        else
          echo "Error: btop binary not found" >&2
          ls -la >&2
          find . -name btop -type f 2>/dev/null >&2
          exit 1
        fi
        ;;
    esac

    chmod +x "$PREFIX/bin/btop"

dependencies:
  - make
  - cmake
