name: "_Scheduled Release - Detect Package Updates"

on:
  workflow_call:
    inputs:
      package:
        description: "Package to build and release (leave empty for all monitored packages)"
        required: false
        type: string
      version:
        description: "Specific version to build (leave empty for latest)"
        required: false
        type: string
      max_updates:
        description: "Maximum number of packages to release"
        required: false
        type: string
        default: "1"
    outputs:
      packages:
        description: "JSON array of packages with updates"
        value: ${{ jobs.detect-updates.outputs.packages }}
      batches:
        description: "JSON array of batches for matrix strategy"
        value: ${{ jobs.detect-updates.outputs.batches }}
      has-updates:
        description: "Boolean indicating if there are any updates"
        value: ${{ jobs.detect-updates.outputs.has-updates }}
    secrets:
      GH_TOKEN:
        required: true

permissions:
  contents: read

jobs:
  detect-updates:
    name: Detect Package Updates
    runs-on: ubuntu-latest
    timeout-minutes: 15
    outputs:
      packages: ${{ steps.monitor.outputs.packages }}
      batches: ${{ steps.split-packages.outputs.batches }}
      has-updates: ${{ steps.split-packages.outputs.has-updates }}
    steps:
      - name: Checkout code
        uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v5

      - name: Setup Go
        uses: actions/setup-go@44694675825211faa026b3c33043df3e48a5fa00 # v6
        with:
          go-version-file: go.mod
          cache: false # Disabled - job only builds CLI once, prevents cleanup warnings

      - name: Build potions CLI
        run: |
          go build -v -o bin/potions ./cmd/potions
          chmod +x bin/potions

      - name: Install yq for YAML parsing
        run: |
          YQ_VERSION="v4.40.5"
          sudo wget -qO /usr/local/bin/yq "https://github.com/mikefarah/yq/releases/download/${YQ_VERSION}/yq_linux_amd64"
          sudo chmod +x /usr/local/bin/yq

      - name: Get recently failed packages
        id: get-failed-packages
        run: |
          echo "ðŸ” Checking recent workflow failures (last 3 days)..."
          FAILED_PACKAGES=$(.github/scripts/get-failed-packages.sh)
          FAILED_COUNT=$(echo "$FAILED_PACKAGES" | jq 'length')

          if [ "$FAILED_COUNT" -gt 0 ]; then
            echo "âš ï¸  Found $FAILED_COUNT recently failed packages:"
            echo "$FAILED_PACKAGES" | jq -r '.[] | "  - \(.)"'
          else
            echo "âœ… No recent workflow failures"
          fi

          echo "failed_packages=$FAILED_PACKAGES" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Monitor for updates
        id: monitor
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          VERSION_INPUT: ${{ inputs.version }}
        run: |
          PACKAGE_INPUT="${{ inputs.package }}"
          FAILED_PACKAGES='${{ steps.get-failed-packages.outputs.failed_packages }}'

          if [ -n "$PACKAGE_INPUT" ]; then
            # Manual trigger with specific package
            [ ! -f "recipes/${PACKAGE_INPUT}.yml" ] && { echo "âŒ Package not found"; echo "packages=[]" >> $GITHUB_OUTPUT; exit 1; }

            PACKAGES=$(.github/scripts/monitor-single-package.sh "$PACKAGE_INPUT")
            PACKAGES="[$PACKAGES]"
            echo "ðŸ“¦ Platforms: $(echo $PACKAGES | jq -r '.[0].platforms | join(", ")')"
          else
            # Scheduled: monitor all packages
            PACKAGES=$(.github/scripts/monitor-all-packages.sh "${{ inputs.max_updates }}" "$FAILED_PACKAGES")
            [ "$(echo $PACKAGES | jq 'length')" -gt 0 ] && echo "$PACKAGES" | jq -r '.[] | "âœ… \(.package): \(.version)"'
          fi

          echo "packages=$PACKAGES" >> $GITHUB_OUTPUT

      - name: Split packages into batches
        id: split-packages
        run: |
          PACKAGES='${{ steps.monitor.outputs.packages }}'
          BATCHES=$(.github/scripts/create-batches.sh "$PACKAGES")

          HAS_UPDATES="false"
          [ "$BATCHES" != "[]" ] && HAS_UPDATES="true"

          echo "batches=$BATCHES" >> $GITHUB_OUTPUT
          echo "has-updates=$HAS_UPDATES" >> $GITHUB_OUTPUT
