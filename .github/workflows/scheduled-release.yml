name: Scheduled Release

on:
  schedule:
    # Run daily at 00:00 UTC
    - cron: "0 0 * * *"
  workflow_dispatch:
    inputs:
      package:
        description: "Package to build and release (leave empty for all monitored packages)"
        required: false
        type: string
      version:
        description: "Specific version to build (leave empty for latest)"
        required: false
        type: string
      dry_run:
        description: "Dry run mode (skip actual release)"
        required: false
        default: false
        type: boolean

# Default to write-all to allow reusable workflows to set their own permissions
permissions: write-all

# Prevent concurrent runs to avoid duplicate builds and releases
concurrency:
  group: build-and-release-${{ github.ref }}
  cancel-in-progress: false

# Global workflow timeout (4 hours max)
env:
  WORKFLOW_TIMEOUT_MINUTES: 240

jobs:
  detect-updates:
    name: Detect Package Updates
    uses: ./.github/workflows/_scheduled-release_detect-updates.yml
    with:
      package: ${{ inputs.package }}
      version: ${{ inputs.version }}
    secrets:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-binaries-linux-x86_64:
    name: Build Binaries (Linux x86_64)
    needs: detect-updates
    if: needs.detect-updates.outputs.has-updates == 'true'
    uses: ./.github/workflows/_scheduled-release_build-binaries-linux-x86_64.yml
    with:
      batches: ${{ needs.detect-updates.outputs.batches }}

  build-binaries-linux-arm64:
    name: Build Binaries (Linux ARM64)
    needs: detect-updates
    if: needs.detect-updates.outputs.has-updates == 'true'
    uses: ./.github/workflows/_scheduled-release_build-binaries-linux-arm64.yml
    with:
      batches: ${{ needs.detect-updates.outputs.batches }}

  build-binaries-macos-arm64:
    name: Build Binaries (macOS ARM64)
    needs: detect-updates
    if: needs.detect-updates.outputs.has-updates == 'true'
    uses: ./.github/workflows/_scheduled-release_build-binaries-macos-arm64.yml
    with:
      batches: ${{ needs.detect-updates.outputs.batches }}

  build-binaries-macos-x86_64:
    name: Build Binaries (macOS Intel)
    needs: detect-updates
    if: needs.detect-updates.outputs.has-updates == 'true'
    uses: ./.github/workflows/_scheduled-release_build-binaries-macos-x86_64.yml
    with:
      batches: ${{ needs.detect-updates.outputs.batches }}

  release-packages:
    name: Release Packages
    needs:
      [
        detect-updates,
        build-binaries-linux-x86_64,
        build-binaries-linux-arm64,
        build-binaries-macos-arm64,
        build-binaries-macos-x86_64,
      ]
    if: always() && needs.detect-updates.result == 'success' && github.event.inputs.dry_run != 'true'
    uses: ./.github/workflows/_scheduled-release_release-packages.yml
    with:
      packages: ${{ needs.detect-updates.outputs.packages }}
      run_id: ${{ github.run_id }}
    secrets:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  workflow-summary:
    name: Workflow Summary
    runs-on: ubuntu-latest
    if: always()
    permissions:
      actions: read # Required for artifact download
    needs:
      [
        detect-updates,
        build-binaries-linux-x86_64,
        build-binaries-linux-arm64,
        build-binaries-macos-arm64,
        build-binaries-macos-x86_64,
        release-packages,
      ]
    steps:
      - name: Download all failure reports
        if: always()
        uses: actions/download-artifact@018cc2cf5baa6db3ef3c5f8a56943fffe632ef53 # v6
        with:
          pattern: "*-batch-*-failures"
          path: failure-reports
          merge-multiple: true
        continue-on-error: true

      - name: Download all success markers
        if: always()
        uses: actions/download-artifact@018cc2cf5baa6db3ef3c5f8a56943fffe632ef53 # v6
        with:
          pattern: "*-batch-*-complete"
          path: success-reports
          merge-multiple: true
        continue-on-error: true

      - name: Generate workflow summary
        run: |
          echo "## ðŸ“Š Scheduled Release Workflow Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Workflow Run:** [${{ github.run_id }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY
          echo "**Trigger:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### Job Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Detect Updates | ${{ needs.detect-updates.result == 'success' && 'âœ… Success' || needs.detect-updates.result == 'failure' && 'âŒ Failed' || needs.detect-updates.result == 'cancelled' && 'â¹ï¸ Cancelled' || 'â­ï¸ Skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Build Linux x86_64 | ${{ needs.build-binaries-linux-x86_64.result == 'success' && 'âœ… Success' || needs.build-binaries-linux-x86_64.result == 'failure' && 'âŒ Failed' || needs.build-binaries-linux-x86_64.result == 'cancelled' && 'â¹ï¸ Cancelled' || 'â­ï¸ Skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Build Linux ARM64 | ${{ needs.build-binaries-linux-arm64.result == 'success' && 'âœ… Success' || needs.build-binaries-linux-arm64.result == 'failure' && 'âŒ Failed' || needs.build-binaries-linux-arm64.result == 'cancelled' && 'â¹ï¸ Cancelled' || 'â­ï¸ Skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Build macOS ARM64 | ${{ needs.build-binaries-macos-arm64.result == 'success' && 'âœ… Success' || needs.build-binaries-macos-arm64.result == 'failure' && 'âŒ Failed' || needs.build-binaries-macos-arm64.result == 'cancelled' && 'â¹ï¸ Cancelled' || 'â­ï¸ Skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Build macOS Intel | ${{ needs.build-binaries-macos-x86_64.result == 'success' && 'âœ… Success' || needs.build-binaries-macos-x86_64.result == 'failure' && 'âŒ Failed' || needs.build-binaries-macos-x86_64.result == 'cancelled' && 'â¹ï¸ Cancelled' || 'â­ï¸ Skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Release Packages | ${{ needs.release-packages.result == 'success' && 'âœ… Success' || needs.release-packages.result == 'failure' && 'âŒ Failed' || needs.release-packages.result == 'cancelled' && 'â¹ï¸ Cancelled' || 'â­ï¸ Skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Collect all successful packages by platform
          if [ -d success-reports ]; then
            echo "### âœ… Successfully Built Packages by Platform" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            # Merge all success files and get unique packages
            cat success-reports/*.txt 2>/dev/null | sort -u > all-successes.txt || touch all-successes.txt

            if [ -s all-successes.txt ]; then
              SUCCESS_COUNT=$(wc -l < all-successes.txt | tr -d ' ')
              echo "**Total: $SUCCESS_COUNT unique package versions**" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY

              # Group by package
              echo "<details>" >> $GITHUB_STEP_SUMMARY
              echo "<summary>View by package</summary>" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY

              while IFS=: read -r package version; do
                echo "#### $package v$version" >> $GITHUB_STEP_SUMMARY
                echo "" >> $GITHUB_STEP_SUMMARY

                # Check which platforms succeeded for this package
                PLATFORMS=""
                grep -Fl "${package}:${version}" success-reports/linux-x86_64-*.txt 2>/dev/null >/dev/null && PLATFORMS="$PLATFORMS linux-x86_64"
                grep -Fl "${package}:${version}" success-reports/linux-arm64-*.txt 2>/dev/null >/dev/null && PLATFORMS="$PLATFORMS linux-arm64"
                grep -Fl "${package}:${version}" success-reports/macos-arm64-*.txt 2>/dev/null >/dev/null && PLATFORMS="$PLATFORMS macos-arm64"
                grep -Fl "${package}:${version}" success-reports/macos-x86_64-*.txt 2>/dev/null >/dev/null && PLATFORMS="$PLATFORMS macos-x86_64"

                echo "**Platforms:**" >> $GITHUB_STEP_SUMMARY
                for platform in $PLATFORMS; do
                  echo "- âœ… $platform" >> $GITHUB_STEP_SUMMARY
                done
                echo "" >> $GITHUB_STEP_SUMMARY
              done < all-successes.txt

              echo "</details>" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
            else
              echo "*No successful builds*" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
            fi
          fi

          # Collect all failures by platform
          if [ -d failure-reports ]; then
            echo "### âŒ Failed Builds by Platform" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            # Merge all failure files
            cat failure-reports/*-failures.txt 2>/dev/null | sort -u > all-failures.txt || touch all-failures.txt
            cat failure-reports/*-failures-timeout.txt 2>/dev/null | sort -u > all-timeouts.txt || touch all-timeouts.txt
            cat failure-reports/*-failures-error.txt 2>/dev/null | sort -u > all-errors.txt || touch all-errors.txt

            TOTAL_FAILURES=0
            [ -s all-failures.txt ] && TOTAL_FAILURES=$(wc -l < all-failures.txt | tr -d ' ')

            if [ $TOTAL_FAILURES -gt 0 ]; then
              echo "**Total: $TOTAL_FAILURES failed builds**" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY

              # Group failures by platform
              echo "<details>" >> $GITHUB_STEP_SUMMARY
              echo "<summary>View failures by platform</summary>" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY

              for platform in "Linux x86_64" "Linux ARM64" "macOS ARM64" "macOS Intel"; do
                case "$platform" in
                  "Linux x86_64")
                    PLATFORM_FILES="failure-reports/linux-x86_64-*-failures*.txt"
                    ;;
                  "Linux ARM64")
                    PLATFORM_FILES="failure-reports/linux-arm64-*-failures*.txt"
                    ;;
                  "macOS ARM64")
                    PLATFORM_FILES="failure-reports/macos-arm64-*-failures*.txt"
                    ;;
                  "macOS Intel")
                    PLATFORM_FILES="failure-reports/macos-x86_64-*-failures*.txt"
                    ;;
                esac

                # Collect failures for this platform
                cat $PLATFORM_FILES 2>/dev/null | sort -u > platform-failures.txt || touch platform-failures.txt

                if [ -s platform-failures.txt ]; then
                  PLATFORM_COUNT=$(wc -l < platform-failures.txt | tr -d ' ')
                  echo "#### $platform ($PLATFORM_COUNT failures)" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY

                  while read -r line; do
                    # Determine failure type
                    if echo "$line" | grep -q "TIMEOUT"; then
                      echo "- â±ï¸ $line" >> $GITHUB_STEP_SUMMARY
                    elif echo "$line" | grep -q "ERROR"; then
                      echo "- âŒ $line" >> $GITHUB_STEP_SUMMARY
                    else
                      echo "- âŒ $line" >> $GITHUB_STEP_SUMMARY
                    fi
                  done < platform-failures.txt
                  echo "" >> $GITHUB_STEP_SUMMARY
                fi

                rm -f platform-failures.txt
              done

              echo "</details>" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
            else
              echo "*No build failures*" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
            fi
          fi

          # Determine overall status
          echo "### Overall Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.detect-updates.result }}" = "failure" ]; then
            echo "âŒ **Workflow Failed** - Package detection failed. Check the detect-updates job logs." >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.release-packages.result }}" = "failure" ]; then
            echo "âš ï¸ **Partial Success** - Builds completed but release creation encountered issues. Check the release-packages job logs." >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.build-binaries-linux-x86_64.result }}" = "failure" ] || [ "${{ needs.build-binaries-linux-arm64.result }}" = "failure" ] || [ "${{ needs.build-binaries-macos-arm64.result }}" = "failure" ] || [ "${{ needs.build-binaries-macos-x86_64.result }}" = "failure" ]; then
            echo "âš ï¸ **Build Failures Detected** - Some builds failed. Partial releases may have been created for successful builds." >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.release-packages.result }}" = "success" ]; then
            echo "âœ… **Workflow Completed Successfully** - All builds and releases completed." >> $GITHUB_STEP_SUMMARY
          else
            echo "â„¹ï¸ **No Updates Found** - No package updates detected. No builds or releases were created." >> $GITHUB_STEP_SUMMARY
          fi
